- name: CachyOS System Setup
  hosts: localhost
  become: true
  connection: local
  gather_facts: true

  vars_files:
    - packages.yml

  vars:
    chaotic_aur_key: "3056513887B78AEB"
    remote_regular_user: "{{ ansible_env.SUDO_USER or ansible_user_id }}"

  tasks:
    - name: Check if Chaotic AUR is already configured
      command: grep -c "^\[chaotic-aur\]" /etc/pacman.conf
      register: chaotic_aur_check
      changed_when: false
      failed_when: false

    - name: Set up Chaotic AUR
      block:
        - name: Import and sign Chaotic AUR key
          shell: |
            pacman-key --recv-key {{ chaotic_aur_key }} --keyserver keyserver.ubuntu.com
            pacman-key --lsign-key {{ chaotic_aur_key }}
          changed_when: false

        - name: Install Chaotic keyring and mirrorlist
          command: pacman -U --noconfirm --overwrite "*" https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst

        - name: Add Chaotic AUR to pacman.conf
          blockinfile:
            path: /etc/pacman.conf
            block: |
              [chaotic-aur]
              Include = /etc/pacman.d/chaotic-mirrorlist
            marker: "# {mark} CHAOTIC AUR REPO"
      when: chaotic_aur_check.stdout == "0"

    - name: System update
      pacman:
        update_cache: yes
        upgrade: yes

    - name: Install packages
      pacman:
        name: "{{ pacman_packages }}"
        state: present
        extra_args: "--noconfirm --noprogressbar"

    - name: Change shell to zsh
      user:
        name: "{{ remote_regular_user }}"
        shell: /usr/bin/zsh

    - name: Setup Flatpak and Flathub
      block:
        - name: Install Flatpak
          pacman:
            name: flatpak
            state: present

        - name: Add Flathub repository
          command: flatpak remote-add --system --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
          changed_when: false

        - name: Install Flatpak packages
          flatpak:
            name: "{{ item }}"
            state: present
            method: system
          loop: "{{ flatpak_packages }}"

    - name: Set timezone
      timezone:
        name: Europe/Vienna
